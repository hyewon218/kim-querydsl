## 📍QueryDSL

- JPA에서 제공하는 객체지향쿼리인 JPQL(Java Persistence Query Language)을 통해 동적 쿼리를 구성하면 코드가 굉장히 난잡해진다는 것을 느낄 수 있다.
- JPQL은 `문자열`을 사용한다. 문자열을 조건에 따라 이어붙이는 형식으로 구성하기 때문에 생기는 문제가 있다. 문자열이기에 **오타가 발생해도 컴파일 단계에서 에러를 잡아주지 못한다.**(다만, NamedQuery를 사용하면 가능하다.) 또한 동적쿼리를 구성할 때, 중간중간 if문에 의해 문자열이 추가되기 때문에 **가독성이 떨어진다.** 따라서 쿼리를 체계적으로 관리하기 어렵다.
- **QueryDSL**은 위와 같은 문제를 해결하기 위해 만들어졌다. Type-Safe한 쿼리를 사용하기 위해 엔티티와 매핑되는 정적 타입 QClass를 생성해 쿼리를 생성할 수 있게 만들었다. 컴파일 단계에서 오류를 잡아낼 수 있고 메소드 체이닝을 통해 조건을 보다 쉽게 추가할 수 있다. 즉, **동적 쿼리를 작성할 때 용이해진다**는 말이다.
- QueryDSL도 내부적으로는 JPQL를 구성해 쿼리를 만들어낸다. 다만, 사용자들이 편하게 사용할 수 있게 추상화해놓은 JPQL 빌더라고 생각하면 된다.

<br>


#### 📌 IntelliJ Gradle 대신에 자바로 바로 실행하기
> 최근 IntelliJ 버전은 Gradle로 실행을 하는 것이 기본 설정이다. 이렇게 하면 실행속도가 느리다. 다음과 같이 변경하면 자바로 바로 실행하므로 좀 더 빨라진다.
1. Preferences Build,Execution,Deployment BuildTools Gradle
2. Build and run using: Gradle IntelliJ IDEA
3. Run tests using: Gradle IntelliJ IDEA
   ![](https://velog.velcdn.com/images/hyewon0218/post/12bc54d6-3bb1-4825-b6e9-7373b0d23b5e/image.jpeg)


#### 📌 동작 확인
> - 기본 테스트 케이스 실행
- 스프링 부트 메인 실행 후 에러페이지로 간단하게 동작 확인(http://localhost:8080)
- 테스트 컨트롤러를 만들어서 spring web 동작 확인(http://localhost:8080/hello)
  ![](https://velog.velcdn.com/images/hyewon0218/post/06c90607-4160-4ea1-9d52-ffa7a1ec10e2/image.jpeg)![](https://velog.velcdn.com/images/hyewon0218/post/3b4a3980-0550-4770-9a3e-b2bbe26e1580/image.jpeg)![](https://velog.velcdn.com/images/hyewon0218/post/73f31cf3-63c4-4aa0-853a-1e13e846a922/image.jpeg)![](https://velog.velcdn.com/images/hyewon0218/post/32a6b26e-ceb7-47b7-977c-6101553a59f8/image.jpeg)

<br>


## 📍Querydsl 설정

```java
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.5'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'study'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    runtimeOnly 'com.h2database:h2'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    // Querydsl 추가 (Spring boot 3.x 이상)
    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
    annotationProcessor "com.querydsl:querydsl-apt:${dependencyManagement.importedProperties['querydsl.version']}:jakarta"
    annotationProcessor "jakarta.annotation:jakarta.annotation-api"
    annotationProcessor "jakarta.persistence:jakarta.persistence-api"
}

tasks.named('test') {
    useJUnitPlatform()
}

/**
 * QueryDSL Build Options
 */
def querydslDir = "src/main/generated"

sourceSets {
    main.java.srcDirs += [ querydslDir ]
}

tasks.withType(JavaCompile).configureEach {
    options.getGeneratedSourceOutputDirectory().set(file(querydslDir))
}

clean.doLast {
    file(querydslDir).deleteDir()
}
```

![](https://velog.velcdn.com/images/hyewon0218/post/6d4136a6-a56f-4b11-8cb4-74f53ceee110/image.jpeg)




<br>

## 📍QClass 생성 및 삭제
### 생성
- Gradle - Task - other - compileJava를 실행하면 된다.![](https://velog.velcdn.com/images/hyewon0218/post/979f2d7c-3e01-45b6-a43b-8bb9114a0572/image.jpeg)

- 아래와 같이 src/main/generated 경로에 QClass가 생성된다.![](https://velog.velcdn.com/images/hyewon0218/post/62b66ddd-4ead-48ef-b504-33edb935e38b/image.jpeg)

### 삭제
- Gradle - Task - build - clean 을 실행하면 된다.
- src/main/generated 디렉토리와 파일이 전부 삭제된다.![](https://velog.velcdn.com/images/hyewon0218/post/5105c953-6081-4c6a-b43d-7973d1cba041/image.jpeg)


### 주의사항

- src/main/generated 디렉토리는 개발할 때 편의를 위해 사용하는 것이다. 실제 배포를 위해 build를 명령어를 실행할 때, 코드 실행을 위해 필요한 QClass들이 build 디렉토리의 entity와 같은 경로에 전부 포함되기 때문에 Docker와 같은 컨테이너에 generated 디렉토리를 COPY해서 넣을 이유가 없다.
- 참고: Q타입은 컴파일 시점에 자동 생성되므로 버전관리(GIT)에 포함하지 않는 것이 좋다. 앞서 설정에서 생성 위치를 gradle build 폴더 아래 생성되도록 했기 때문에 이 부분도 자연스럽게 해결된다. (대부분 gradle build 폴더를 git에 포함하지 않는다.)

## 📍Querydsl검증
테스트 케이스로 실행 검증
![](https://velog.velcdn.com/images/hyewon0218/post/f12ab700-5b72-4a55-a987-a77487fc167e/image.jpeg)![](https://velog.velcdn.com/images/hyewon0218/post/adefd3ff-4dcc-4916-9d3d-d6ca2e88024c/image.jpeg)

- Querydsl Q타입이 정상 동작하는가?
- lombok이 정상 동작 하는가?
> 참고: 스프링 부트에 아무런 설정도 하지 않으면 h2 DB를 메모리 모드로 JVM안에서 실행한다.

<br>

## 📍**Querydsl 라이브러리 살펴보기**

- querydsl-**apt**: Querydsl 관련 코드 **생성** 기능 제공(코드 제너레이션  라이브러리 ex)Qhello )
- querydsl-**jpa**: querydsl 라이브러리(실제 코드 제너레이션을 만들기 위해 사용하는 라이브러리)
- **querydsl-apt**는 소스 코드 레벨에서 Querydsl 관련 어노테이션들을 처리하고 쿼리 타입 클래스들을 생성해주는 역할을 한다. 이를 통해 쿼리를 직접 작성하는 대신 Java 코드를 활용하여 컴파일러가 검사하는 안전한 방법으로 쿼리를 작성할 수 있다. sourceSets에 QClass를 저장할 경로를 설정해주면 해당 경로에 쿼리 타입 클래스를 생성해준다.
  ![](https://velog.velcdn.com/images/hyewon0218/post/bdcc2087-6d89-4bbc-b2af-206a0818ef76/image.jpeg)
  테스트짤 때 편리한 라이브러리
  ![](https://velog.velcdn.com/images/hyewon0218/post/33a3527e-3e78-45df-aa3b-eceba79f62e8/image.jpeg)

<br>

## 📍H2 데이터베이스 설치

개발이나 테스트 용도로 가볍고 편리한 DB, 웹 화면 제공
```java
choihyewon@choehyewon-ui-noteubug Spring % cd /Users/choihyewon/Desktop/개발/Backend_Spring/Spring/kim-querydsl
choihyewon@choehyewon-ui-noteubug kim-querydsl % cd h2/bin
choihyewon@choehyewon-ui-noteubug bin % chmod 755 h2.sh
choihyewon@choehyewon-ui-noteubug bin % ls -alrth
total 5136
-rw-rw-r--@ 1 choihyewon  staff   105B Sep 16 18:03 h2w.bat
-rwxr-xr-x@ 1 choihyewon  staff   109B Sep 16 18:03 h2.sh
-rw-rw-r--@ 1 choihyewon  staff    98B Sep 16 18:03 h2.bat
-rw-rw-r--@ 1 choihyewon  staff   2.5M Sep 16 18:03 h2-2.2.224.jar
drwxr-xr-x@ 6 choihyewon  staff   192B Oct 24 22:56 .
drwxr-xr-x@ 9 choihyewon  staff   288B Oct 24 22:59 ..
choihyewon@choehyewon-ui-noteubug bin % ./h2.sh
```
![](https://velog.velcdn.com/images/hyewon0218/post/7de0a668-db72-4e0f-a456-63e1fa9b410c/image.jpeg)
![](https://velog.velcdn.com/images/hyewon0218/post/21029990-f90e-4957-9147-743650b17a90/image.jpeg)
<br>최소 한번
![](https://velog.velcdn.com/images/hyewon0218/post/c2ceba17-7496-46d3-a83d-adb571d13310/image.jpeg)
데이터베이스 생성! → 연결끊고→ jdbc:h2:tcp://localhost/~/querydsl 이렇게 접속
![](https://velog.velcdn.com/images/hyewon0218/post/8e32a4e1-2541-4ecc-b457-8bef8d385613/image.jpeg)

insert
![](https://velog.velcdn.com/images/hyewon0218/post/c5f975a7-a453-4747-a0c0-8dc9c79e6d6a/image.jpeg)
![](https://velog.velcdn.com/images/hyewon0218/post/9a06bca9-601c-44fd-be30-854f2e76ddb9/image.jpeg)
<br>조회했는데 데이터가 없는이유? 테스트에 트랜잭셔널이 있으면 기본적으로 롤백을 해버린다! → @commit 달아주면

![](https://velog.velcdn.com/images/hyewon0218/post/ffdda9ba-34a0-4f98-a14f-a0aa70dbe196/image.jpeg)

쿼리파라미터 로그 남기기 - 스프링 부트 3.0
```java
implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.0'
```

![](https://velog.velcdn.com/images/hyewon0218/post/ffd2622e-2c37-4791-9188-ddcbe869447f/image.jpeg)
